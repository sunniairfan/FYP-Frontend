package com.example.androidmalwaredetector.ui.screens

import android.content.ActivityNotFoundException
import android.content.Intent
import android.content.pm.PackageManager
import android.content.pm.PermissionInfo
import android.graphics.drawable.Drawable
import android.net.Uri
import android.provider.Settings
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.foundation.BorderStroke
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material3.*

import androidx.compose.runtime.*
import androidx.activity.compose.BackHandler
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.asImageBitmap
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.core.graphics.drawable.toBitmap
import androidx.navigation.NavController
import com.example.androidmalwaredetector.ui.components.StatusBadge
import com.example.androidmalwaredetector.util.MalwareDetector
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import androidx.compose.material.icons.filled.Warning

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun StandAloneDetailScreen(
    packageName: String,
    appName: String,
    navController: NavController
) {
    // Handle back press
    BackHandler {
        navController.navigateUp()
    }
    
    // Get the Android context and PackageManager
    val context = LocalContext.current
    val pm = context.packageManager
    val malwareDetector = remember { MalwareDetector(context) }
    
    // State variables for app details
    var appIcon by remember { mutableStateOf<Drawable?>(null) }
    var sizeInMB by remember { mutableStateOf(0.0) }
    var dangerousPermissions by remember { mutableStateOf<List<String>>(emptyList()) }
    var predictionScore by remember { mutableStateOf(0.5f) }
    var predictionLabel by remember { mutableStateOf("unknown") }
    var isLoading by remember { mutableStateOf(true) }
    val coroutineScope = rememberCoroutineScope()

    // Cyber theme colors
    val cyberBg = Color(0xFF0A0A0A)
    val cyberAccent = Color(0xFF00FFFF)
    val cyberSecondary = Color(0xFF1A1A2E)
    val cyberError = Color(0xFFFF4444)
    val cyberText = Color(0xFFE0E0E0)
    val cyberDim = Color(0xFF808080)
    
    // Load app details when packageName changes
    LaunchedEffect(packageName) {
        try {
            withContext(Dispatchers.Default) {
                // Get ApplicationInfo for the given package
                val appInfo = pm.getApplicationInfo(packageName, 0)
                appIcon = pm.getApplicationIcon(appInfo)
                
                // Get APK file details
                val apkPath = appInfo.sourceDir
                val apkFile = java.io.File(apkPath)
                sizeInMB = apkFile.length().toDouble() / (1024 * 1024)
                
                // Get requested permissions
                val packageInfo = pm.getPackageInfo(packageName, PackageManager.GET_PERMISSIONS)
                val requestedPermissions = packageInfo.requestedPermissions
                val filtered = mutableListOf<String>()
                
                // Filter for dangerous permissions
                requestedPermissions?.forEach { permission ->
                    try {
                        val permInfo = pm.getPermissionInfo(permission, 0)
                        if ((permInfo.protectionLevel and PermissionInfo.PROTECTION_DANGEROUS) != 0) {
                            filtered.add(permission)
                        }
                    } catch (_: Exception) {}
                }
                
                dangerousPermissions = filtered
                
                // Get ML prediction
                val prediction = malwareDetector.predictMalware(packageName, pm)
                predictionScore = prediction.score
                predictionLabel = prediction.label
            }
            isLoading = false
        } catch (e: Exception) {
            e.printStackTrace()
            isLoading = false
        }
    }
    
    // Function to initiate app uninstallation
    fun uninstallApp() {
        try {
            val uninstallIntent = Intent(Intent.ACTION_UNINSTALL_PACKAGE).apply {
                data = Uri.parse("package:$packageName")
                putExtra(Intent.EXTRA_RETURN_RESULT, true)
            }
            context.startActivity(uninstallIntent)
        } catch (e: ActivityNotFoundException) {
            try {
                val deleteIntent = Intent(Intent.ACTION_DELETE).apply {
                    data = Uri.parse("package:$packageName")
                }
                context.startActivity(deleteIntent)
            } catch (e2: Exception) {
                try {
                    val settingsIntent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS).apply {
                        data = Uri.parse("package:$packageName")
                    }
                    context.startActivity(settingsIntent)
                } catch (e3: Exception) {
                    e3.printStackTrace()
                }
            }
        }
    }
    
    // Function to open app info settings
    fun openAppSettings() {
        try {
            val intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS).apply {
                data = Uri.parse("package:$packageName")
            }
            context.startActivity(intent)
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    // Main UI structure with scrollable content
    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(
                Brush.verticalGradient(
                    colors = listOf(
                        Color(0xFF0A0E27),
                        Color(0xFF0D1630)
                    )
                )
            )
    ) {
        // Top App Bar
        CenterAlignedTopAppBar(
            title = {
                Text(
                    "APP DETAILS",
                    color = cyberAccent,
                    fontWeight = FontWeight.Bold,
                    fontSize = 18.sp,
                    letterSpacing = 1.5.sp
                )
            },
            navigationIcon = {
                IconButton(onClick = { navController.navigateUp() }) {
                    Icon(
                        Icons.Default.ArrowBack,
                        contentDescription = "Back",
                        tint = cyberAccent
                    )
                }
            },
            colors = TopAppBarDefaults.centerAlignedTopAppBarColors(
                containerColor = Color.Transparent
            )
        )

        if (isLoading) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .background(cyberBg),
                contentAlignment = Alignment.Center
            ) {
                CircularProgressIndicator(
                    color = cyberAccent,
                    modifier = Modifier.size(48.dp)
                )
            }
        } else {
            Column(
                modifier = Modifier
                    .fillMaxSize()
                    .verticalScroll(rememberScrollState())
                    .padding(24.dp)
            ) {
                // App Header Section
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(bottom = 24.dp),
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    // App Icon
                    appIcon?.let {
                        Image(
                            bitmap = it.toBitmap().asImageBitmap(),
                            contentDescription = null,
                            modifier = Modifier
                                .size(80.dp)
                                .clip(RoundedCornerShape(12.dp))
                                .border(2.dp, cyberAccent, RoundedCornerShape(12.dp))
                        )
                    }

                    // App Info
                    Column(modifier = Modifier.weight(1f)) {
                        Text(
                            text = appName,
                            style = MaterialTheme.typography.titleLarge.copy(
                                fontWeight = FontWeight.Bold,
                                fontSize = 20.sp,
                                color = Color.White
                            )
                        )
                        Text(
                            text = packageName,
                            style = MaterialTheme.typography.bodySmall.copy(
                                color = cyberDim,
                                fontSize = 11.sp
                            )
                        )
                        Text(
                            text = "Size: %.2f MB".format(sizeInMB),
                            style = MaterialTheme.typography.bodySmall.copy(
                                color = cyberAccent,
                                fontSize = 12.sp,
                                fontWeight = FontWeight.SemiBold
                            ),
                            modifier = Modifier.padding(top = 4.dp)
                        )
                    }
                }

                // ML Prediction Section
                Card(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(bottom = 16.dp)
                        .shadow(8.dp, RoundedCornerShape(16.dp)),
                    shape = RoundedCornerShape(16.dp),
                    colors = CardDefaults.cardColors(
                        containerColor = cyberSecondary.copy(alpha = 0.7f)
                    )
                ) {
                    Column(modifier = Modifier.padding(16.dp)) {
                        Text(
                            "ML PREDICTION",
                            style = MaterialTheme.typography.titleSmall.copy(
                                fontWeight = FontWeight.Bold,
                                color = cyberAccent,
                                fontSize = 12.sp,
                                letterSpacing = 1.sp
                            ),
                            modifier = Modifier.padding(bottom = 12.dp)
                        )

                        val predictionColor = when (predictionLabel) {
                            "safe" -> Color(0xFF4CAF50)
                            "risky" -> Color(0xFFFFC107)
                            "malware" -> Color(0xFFFF5252)
                            else -> Color.Gray
                        }

                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            verticalAlignment = Alignment.CenterVertically,
                            horizontalArrangement = Arrangement.SpaceBetween
                        ) {
                            Column {
                                Text(
                                    "Threat Score:",
                                    style = MaterialTheme.typography.bodySmall.copy(
                                        color = cyberText,
                                        fontSize = 12.sp
                                    )
                                )
                                Text(
                                    String.format("%.3f", predictionScore),
                                    style = MaterialTheme.typography.titleLarge.copy(
                                        color = predictionColor,
                                        fontWeight = FontWeight.Bold,
                                        fontSize = 24.sp
                                    ),
                                    modifier = Modifier.padding(top = 4.dp)
                                )
                            }

                            Surface(
                                color = predictionColor.copy(alpha = 0.2f),
                                shape = RoundedCornerShape(12.dp),
                                modifier = Modifier.border(
                                    2.dp,
                                    predictionColor.copy(alpha = 0.5f),
                                    RoundedCornerShape(12.dp)
                                )
                            ) {
                                Text(
                                    predictionLabel.uppercase(),
                                    style = MaterialTheme.typography.labelLarge.copy(
                                        color = predictionColor,
                                        fontWeight = FontWeight.Bold,
                                        fontSize = 16.sp
                                    ),
                                    modifier = Modifier.padding(
                                        horizontal = 16.dp,
                                        vertical = 8.dp
                                    )
                                )
                            }
                        }
                    }
                }

                // Dangerous Permissions Section
                if (dangerousPermissions.isNotEmpty()) {
                    Text(
                        "DANGEROUS PERMISSIONS (${dangerousPermissions.size})",
                        style = MaterialTheme.typography.labelSmall.copy(
                            fontWeight = FontWeight.Bold,
                            color = cyberAccent,
                            fontSize = 12.sp,
                            letterSpacing = 1.sp
                        ),
                        modifier = Modifier.padding(bottom = 12.dp)
                    )

                    Column(
                        verticalArrangement = Arrangement.spacedBy(8.dp),
                        modifier = Modifier.padding(bottom = 24.dp)
                    ) {
                        dangerousPermissions.forEach { permission ->
                            Row(
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .background(
                                        cyberSecondary.copy(alpha = 0.5f),
                                        RoundedCornerShape(8.dp)
                                    )
                                    .padding(12.dp),
                                horizontalArrangement = Arrangement.spacedBy(8.dp),
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                Icon(
                                    imageVector = Icons.Default.Warning,
                                    contentDescription = null,
                                    tint = Color(0xFFFFC107),
                                    modifier = Modifier.size(16.dp)
                                )
                                Text(
                                    permission.substringAfterLast('.'),
                                    style = MaterialTheme.typography.bodySmall.copy(
                                        color = cyberText,
                                        fontSize = 11.sp
                                    ),
                                    modifier = Modifier.weight(1f)
                                )
                            }
                        }
                    }
                } else {
                    Text(
                        "NO DANGEROUS PERMISSIONS",
                        style = MaterialTheme.typography.labelSmall.copy(
                            fontWeight = FontWeight.Bold,
                            color = Color(0xFF4CAF50),
                            fontSize = 12.sp,
                            letterSpacing = 1.sp
                        ),
                        modifier = Modifier.padding(bottom = 24.dp)
                    )
                }

                // Action Buttons
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(bottom = 16.dp),
                    horizontalArrangement = Arrangement.spacedBy(12.dp)
                ) {
                    Button(
                        onClick = { openAppSettings() },
                        modifier = Modifier
                            .weight(1f)
                            .height(48.dp),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = cyberSecondary,
                            contentColor = cyberAccent
                        ),
                        shape = RoundedCornerShape(12.dp),
                        border = BorderStroke(1.dp, cyberAccent.copy(alpha = 0.5f))
                    ) {
                        Text(
                            "App Settings",
                            fontWeight = FontWeight.Bold,
                            fontSize = 12.sp
                        )
                    }

                    Button(
                        onClick = { uninstallApp() },
                        modifier = Modifier
                            .weight(1f)
                            .height(48.dp),
                        colors = ButtonDefaults.buttonColors(
                            containerColor = cyberError.copy(alpha = 0.2f),
                            contentColor = cyberError
                        ),
                        shape = RoundedCornerShape(12.dp),
                        border = BorderStroke(1.dp, cyberError.copy(alpha = 0.5f))
                    ) {
                        Text(
                            "Uninstall",
                            fontWeight = FontWeight.Bold,
                            fontSize = 12.sp
                        )
                    }
                }
            }
        }
    }
}
