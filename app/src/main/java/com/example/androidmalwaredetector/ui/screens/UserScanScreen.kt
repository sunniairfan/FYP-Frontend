package com.example.androidmalwaredetector.ui.screens

import androidx.activity.compose.BackHandler
import androidx.compose.animation.core.*
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.Canvas
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Star
import androidx.compose.material.icons.filled.Warning
import androidx.compose.material.icons.filled.CheckCircle
import androidx.compose.material.icons.filled.Close
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.blur
import androidx.compose.ui.draw.scale
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.draw.rotate
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.Path
import androidx.compose.ui.graphics.Paint
import androidx.compose.ui.graphics.PaintingStyle
import androidx.compose.ui.graphics.asImageBitmap
import androidx.compose.ui.graphics.drawscope.drawIntoCanvas
import androidx.compose.ui.graphics.drawscope.Stroke
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.unit.sp
import androidx.navigation.NavController
import androidx.core.graphics.drawable.toBitmap
import java.io.File
import com.example.androidmalwaredetector.scanner.DroidGuardScanner
import com.example.androidmalwaredetector.scanner.ScanConfig
import com.example.androidmalwaredetector.scanner.ScanResult
import com.example.androidmalwaredetector.scanner.ThreatLevel
import com.example.androidmalwaredetector.ui.components.StatusBadge
import com.example.androidmalwaredetector.ui.theme.DarkNavy
import com.example.androidmalwaredetector.ui.theme.NeonCyan
import com.example.androidmalwaredetector.ui.theme.DarkGray
import com.example.androidmalwaredetector.util.uploadMLAnalysisResults
import kotlinx.coroutines.launch
import com.example.androidmalwaredetector.ui.components.RevealScanPanel

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun UserScanScreen(
    navController: NavController,
    showResultsInitially: Boolean = false
) {
    val context = LocalContext.current
    val scope = rememberCoroutineScope()
    
    var isScanning by remember { mutableStateOf(false) }
    var scanResults by remember { mutableStateOf(ScanStateManager.getScanResults()) }
    var scanProgress by remember { mutableStateOf(0f) }
    var currentScanning by remember { mutableStateOf("") }
    var showResults by rememberSaveable { mutableStateOf(showResultsInitially || ScanStateManager.hasScanResults()) }
    var showSystemApps by rememberSaveable { mutableStateOf(false) } // Toggle between user and system apps
    
    val scanner = remember { DroidGuardScanner(context) }
    
    // Handle back navigation when in results mode
    BackHandler(enabled = showResults) {
        showResults = false
        ScanStateManager.clearScanResults()
    }
    
    // Filter results based on current view
    val filteredResults = remember(scanResults, showSystemApps) {
        scanResults.filterIsInstance<ScanResult.Success>().filter { result ->
            val isSystemApp = result.isSystemApp ?: false
            if (showSystemApps) isSystemApp else !isSystemApp
        }
    }
    
    // Count user and system apps
    val userAppsCount = remember(scanResults) {
        scanResults.filterIsInstance<ScanResult.Success>().count { !(it.isSystemApp ?: false) }
    }
    val systemAppsCount = remember(scanResults) {
        scanResults.filterIsInstance<ScanResult.Success>().count { it.isSystemApp ?: false }
    }
    
    // Animation for scan button
    val infiniteTransition = rememberInfiniteTransition(label = "scan_glow")
    val glowAnimation by infiniteTransition.animateFloat(
        initialValue = 0.6f,
        targetValue = 1f,
        animationSpec = infiniteRepeatable(
            animation = tween(2000),
            repeatMode = RepeatMode.Reverse
        ),
        label = "scan_glow"
    )

    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(
                Brush.verticalGradient(
                    colors = listOf(
                        DarkNavy,
                        Color(0xFF0D1421),
                        DarkNavy
                    )
                )
            )
    ) {
        Column(
            modifier = Modifier.fillMaxSize(),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            if (!showResults) {
                // Scan interface - fully centered without top app bar
                Box(
                    modifier = Modifier.fillMaxSize(),
                    contentAlignment = Alignment.Center
                ) {
                    if (isScanning) {
                        // Enhanced scanning progress UI
                        Column(
                            horizontalAlignment = Alignment.CenterHorizontally,
                            verticalArrangement = Arrangement.Center
                        ) {
                            // Large circular progress with app icon
                            Box(
                                contentAlignment = Alignment.Center,
                                modifier = Modifier.size(200.dp)
                            ) {
                                // Outer glow effect
                                Box(
                                    modifier = Modifier
                                        .size(220.dp)
                                        .background(
                                            NeonCyan.copy(alpha = 0.1f),
                                            shape = androidx.compose.foundation.shape.CircleShape
                                        )
                                        .blur(20.dp)
                                )
                                
                                // Main circular progress
                                CircularProgressIndicator(
                                    progress = scanProgress,
                                    modifier = Modifier.size(180.dp),
                                    color = NeonCyan,
                                    strokeWidth = 6.dp,
                                    trackColor = Color.White.copy(alpha = 0.1f)
                                )
                                
                                // App icon container with better styling
                                Box(
                                    contentAlignment = Alignment.Center,
                                    modifier = Modifier
                                        .size(120.dp)
                                        .background(
                                            Color.White.copy(alpha = 0.15f),
                                            shape = androidx.compose.foundation.shape.CircleShape
                                        )
                                        .border(
                                            2.dp,
                                            NeonCyan.copy(alpha = 0.3f),
                                            androidx.compose.foundation.shape.CircleShape
                                        )
                                ) {
                                    // Show actual app icon with better quality
                                    if (currentScanning.isNotEmpty()) {
                                        val packageManager = context.packageManager
                                        val appIconDrawable = remember(currentScanning) {
                                            try {
                                                val appInfo = packageManager.getApplicationInfo(currentScanning, 0)
                                                packageManager.getApplicationIcon(appInfo)
                                            } catch (e: Exception) {
                                                null
                                            }
                                        }
                                        
                                        if (appIconDrawable != null) {
                                            val bitmap = remember(appIconDrawable) {
                                                appIconDrawable.toBitmap(80, 80) // Higher resolution
                                            }
                                            val imageBitmap = remember(bitmap) {
                                                bitmap.asImageBitmap()
                                            }
                                            
                                            Image(
                                                bitmap = imageBitmap,
                                                contentDescription = "Current App Icon",
                                                modifier = Modifier
                                                    .size(80.dp)
                                                    .background(
                                                        Color.White,
                                                        shape = RoundedCornerShape(16.dp)
                                                    )
                                                    .padding(8.dp)
                                            )
                                        } else {
                                            // Enhanced fallback icon
                                            Icon(
                                                Icons.Default.Star,
                                                contentDescription = "Current App",
                                                modifier = Modifier.size(50.dp),
                                                tint = NeonCyan
                                            )
                                        }
                                    } else {
                                        // Default scanner icon
                                        Icon(
                                            Icons.Default.Star,
                                            contentDescription = "Scanner",
                                            modifier = Modifier.size(50.dp),
                                            tint = NeonCyan
                                        )
                                    }
                                }
                            }
                            
                            Spacer(modifier = Modifier.height(32.dp))
                            
                            // Scanning status text
                            Text(
                                text = "SCANNING APPLICATIONS",
                                style = MaterialTheme.typography.titleMedium.copy(
                                    fontWeight = FontWeight.Bold,
                                    letterSpacing = 2.sp
                                ),
                                color = NeonCyan
                            )
                            
                            Spacer(modifier = Modifier.height(12.dp))
                            
                            // App name being analyzed with better styling
                            if (currentScanning.isNotEmpty()) {
                                Card(
                                    modifier = Modifier.padding(horizontal = 24.dp),
                                    colors = CardDefaults.cardColors(
                                        containerColor = Color.White.copy(alpha = 0.1f)
                                    ),
                                    shape = RoundedCornerShape(12.dp)
                                ) {
                                    Text(
                                        text = currentScanning,
                                        style = MaterialTheme.typography.bodyMedium,
                                        color = Color.White.copy(alpha = 0.9f),
                                        textAlign = TextAlign.Center,
                                        modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)
                                    )
                                }
                                
                                Spacer(modifier = Modifier.height(16.dp))
                            }
                            
                            // Reduced percentage display
                            Text(
                                text = "${(scanProgress * 100).toInt()}%",
                                style = MaterialTheme.typography.headlineMedium.copy( // Reduced from displayMedium
                                    fontWeight = FontWeight.Bold // Reduced from ExtraBold
                                ),
                                color = Color.White
                            )
                            
                            Spacer(modifier = Modifier.height(48.dp))
                            
                            // Enhanced stop scanning button
                            Button(
                                onClick = { 
                                    isScanning = false
                                    showResults = false
                                },
                                colors = ButtonDefaults.buttonColors(
                                    containerColor = Color(0xFFFF6B6B) // Modern red color
                                ),
                                modifier = Modifier
                                    .width(200.dp)
                                    .height(50.dp),
                                shape = RoundedCornerShape(25.dp),
                                elevation = ButtonDefaults.buttonElevation(
                                    defaultElevation = 8.dp,
                                    pressedElevation = 4.dp
                                )
                            ) {
                                Text(
                                    text = "Stop Scanning",
                                    color = Color.White,
                                    style = MaterialTheme.typography.bodyLarge.copy(
                                        fontWeight = FontWeight.SemiBold
                                    )
                                )
                            }
                        }
                    } else {
                        // Extracted start scan lambda so RevealScanPanel can call same flow
                        val startScan: () -> Unit = {
                            scope.launch {
                                isScanning = true
                                scanProgress = 0f
                                scanResults = emptyList()
                                ScanStateManager.clearScanResults() // Clear previous results

                                val results = scanner.scanAllInstalledApps(
                                    config = ScanConfig(includeSystemApps = true) // Include both user and system apps
                                ) { completed, total, packageName ->
                                    scanProgress = completed.toFloat() / total.toFloat()
                                    currentScanning = packageName
                                }

                                scanResults = results
                                ScanStateManager.setScanResults(results) // Cache results

                                // Upload ML analysis results to backend for user apps only
                                try {
                                    val successResults = results.filterIsInstance<ScanResult.Success>()
                                    uploadMLAnalysisResults(context, successResults)
                                } catch (e: Exception) {
                                    // Log error but don't interrupt UI flow
                                    e.printStackTrace()
                                }

                                isScanning = false
                                showResults = true
                            }
                        }

                        // Professional interactive scan button
                        Column(
                            horizontalAlignment = Alignment.CenterHorizontally,
                            verticalArrangement = Arrangement.Center
                        ) {
                            // Premium interactive scan button
                            var isPressed by remember { mutableStateOf(false) }
                            var isHovered by remember { mutableStateOf(false) }
                            
                            // Smooth pulse animation
                            val infiniteTransition = rememberInfiniteTransition(label = "pulse")
                            val pulseScale by infiniteTransition.animateFloat(
                                initialValue = 1f,
                                targetValue = 1.05f,
                                animationSpec = infiniteRepeatable(
                                    animation = tween(2000, easing = FastOutSlowInEasing),
                                    repeatMode = RepeatMode.Reverse
                                ), label = "pulse_scale"
                            )
                            
                            // Gradient color animation
                            val gradientShift by infiniteTransition.animateFloat(
                                initialValue = 0f,
                                targetValue = 1f,
                                animationSpec = infiniteRepeatable(
                                    animation = tween(3000, easing = LinearEasing),
                                    repeatMode = RepeatMode.Restart
                                ), label = "gradient_shift"
                            )
                            
                            // Button scale for interactions
                            val buttonScale by animateFloatAsState(
                                targetValue = when {
                                    isPressed -> 0.92f
                                    isHovered -> 1.08f
                                    else -> pulseScale
                                },
                                animationSpec = spring(
                                    dampingRatio = Spring.DampingRatioMediumBouncy,
                                    stiffness = Spring.StiffnessMedium
                                ),
                                label = "button_scale"
                            )
                            
                            // Elevation animation
                            val elevation by animateFloatAsState(
                                targetValue = when {
                                    isPressed -> 4.dp.value
                                    isHovered -> 16.dp.value
                                    else -> 8.dp.value
                                },
                                animationSpec = tween(200),
                                label = "elevation"
                            )
                            
                            Box(
                                contentAlignment = Alignment.Center,
                                modifier = Modifier.size(220.dp)
                            ) {
                                // Outer glow rings
                                repeat(3) { ring ->
                                    val ringScale = 1f + (ring * 0.15f)
                                    val ringAlpha = (0.15f - ring * 0.05f) * if (isHovered) 1.5f else 1f
                                    
                                    Box(
                                        modifier = Modifier
                                            .size((180 * ringScale).dp)
                                            .scale(buttonScale * 0.95f)
                                            .background(
                                                brush = Brush.radialGradient(
                                                    colors = listOf(
                                                        NeonCyan.copy(alpha = ringAlpha),
                                                        Color.Transparent
                                                    ),
                                                    radius = 200f
                                                ),
                                                shape = androidx.compose.foundation.shape.CircleShape
                                            )
                                            .blur((6 + ring * 4).dp)
                                    )
                                }
                                
                                // Main button with premium gradient
                                Button(
                                    onClick = { startScan() },
                                    modifier = Modifier
                                        .size(180.dp)
                                        .scale(buttonScale)
                                        .pointerInput(Unit) {
                                            detectTapGestures(
                                                onPress = {
                                                    isPressed = true
                                                    isHovered = true
                                                    tryAwaitRelease()
                                                    isPressed = false
                                                    kotlinx.coroutines.delay(150)
                                                    isHovered = false
                                                }
                                            )
                                        },
                                    colors = ButtonDefaults.buttonColors(
                                        containerColor = Color.Transparent
                                    ),
                                    shape = androidx.compose.foundation.shape.CircleShape,
                                    elevation = ButtonDefaults.buttonElevation(
                                        defaultElevation = elevation.dp
                                    ),
                                    border = BorderStroke(
                                        width = 2.dp,
                                        brush = Brush.sweepGradient(
                                            colors = listOf(
                                                Color.White.copy(alpha = 0.6f),
                                                NeonCyan.copy(alpha = 0.8f),
                                                Color.White.copy(alpha = 0.6f),
                                                NeonCyan.copy(alpha = 0.8f)
                                            )
                                        )
                                    ),
                                    contentPadding = PaddingValues(0.dp)
                                ) {
                                    Box(
                                        modifier = Modifier
                                            .fillMaxSize()
                                            .background(
                                                brush = Brush.radialGradient(
                                                    colors = listOf(
                                                        Color(0xFF1E40AF).copy(alpha = 0.95f),
                                                        Color(0xFF1E3A8A).copy(alpha = 0.98f),
                                                        Color(0xFF1E293B)
                                                    ),
                                                    center = Offset(
                                                        x = 0.3f + gradientShift * 0.4f,
                                                        y = 0.3f + gradientShift * 0.4f
                                                    )
                                                ),
                                                shape = androidx.compose.foundation.shape.CircleShape
                                            ),
                                        contentAlignment = Alignment.Center
                                    ) {
                                        Column(
                                            horizontalAlignment = Alignment.CenterHorizontally,
                                            verticalArrangement = Arrangement.Center
                                        ) {
                                            // Icon with rotation animation
                                            val iconRotation by infiniteTransition.animateFloat(
                                                initialValue = 0f,
                                                targetValue = 360f,
                                                animationSpec = infiniteRepeatable(
                                                    animation = tween(8000, easing = LinearEasing)
                                                ), label = "icon_rotation"
                                            )
                                            
                                            Icon(
                                                painter = androidx.compose.ui.res.painterResource(
                                                    id = com.example.androidmalwaredetector.R.drawable.ic_shield
                                                ),
                                                contentDescription = "Security Scan",
                                                tint = Color.White,
                                                modifier = Modifier
                                                    .size(32.dp)
                                                    .rotate(if (isHovered) iconRotation else 0f)
                                            )
                                            
                                            Spacer(modifier = Modifier.height(8.dp))
                                            
                                            // Animated text
                                            val textAlpha by animateFloatAsState(
                                                targetValue = if (isPressed) 0.7f else 1f,
                                                animationSpec = tween(100),
                                                label = "text_alpha"
                                            )
                                            
                                            Text(
                                                text = "SCAN NOW",
                                                style = MaterialTheme.typography.titleMedium.copy(
                                                    fontWeight = FontWeight.ExtraBold,
                                                    letterSpacing = 2.sp
                                                ),
                                                color = Color.White.copy(alpha = textAlpha),
                                                textAlign = TextAlign.Center
                                            )
                                            
                                            // Subtle scanning indicator
                                            if (isHovered) {
                                                Spacer(modifier = Modifier.height(4.dp))
                                                
                                                Row(
                                                    horizontalArrangement = Arrangement.spacedBy(3.dp)
                                                ) {
                                                    repeat(3) { index ->
                                                        val dotScale by infiniteTransition.animateFloat(
                                                            initialValue = 0.5f,
                                                            targetValue = 1f,
                                                            animationSpec = infiniteRepeatable(
                                                                animation = tween(
                                                                    durationMillis = 600,
                                                                    delayMillis = index * 150
                                                                ),
                                                                repeatMode = RepeatMode.Reverse
                                                            ), label = "dot_$index"
                                                        )
                                                        
                                                        Box(
                                                            modifier = Modifier
                                                                .size(4.dp)
                                                                .scale(dotScale)
                                                                .background(
                                                                    NeonCyan,
                                                                    shape = androidx.compose.foundation.shape.CircleShape
                                                                )
                                                        )
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            
                            Spacer(modifier = Modifier.height(24.dp))
                            
                            // Professional instructional card with subtle effects
                            val cardScale by animateFloatAsState(
                                targetValue = if (isPressed) 1.02f else 1f,
                                animationSpec = spring(
                                    dampingRatio = Spring.DampingRatioMediumBouncy,
                                    stiffness = Spring.StiffnessLow
                                ),
                                label = "card_scale"
                            )
                            
                            val cardElevation by animateFloatAsState(
                                targetValue = if (isHovered) 6f else 4f,
                                animationSpec = tween(200),
                                label = "card_elevation"
                            )
                            
                            Card(
                                colors = CardDefaults.cardColors(
                                    containerColor = Color.White.copy(alpha = if (isHovered) 0.1f else 0.08f)
                                ),
                                shape = RoundedCornerShape(16.dp),
                                modifier = Modifier
                                    .padding(horizontal = 32.dp)
                                    .fillMaxWidth()
                                    .scale(cardScale),
                                elevation = CardDefaults.cardElevation(
                                    defaultElevation = cardElevation.dp
                                ),
                                border = BorderStroke(
                                    1.dp,
                                    NeonCyan.copy(alpha = if (isHovered) 0.3f else 0.2f)
                                )
                            ) {
                                Column(
                                    modifier = Modifier.padding(16.dp),
                                    horizontalAlignment = Alignment.CenterHorizontally
                                ) {
                                    // Subtle text animation for title
                                    val titleAlpha by infiniteTransition.animateFloat(
                                        initialValue = 0.8f,
                                        targetValue = 1f,
                                        animationSpec = infiniteRepeatable(
                                            animation = tween(3000, easing = FastOutSlowInEasing),
                                            repeatMode = RepeatMode.Reverse
                                        ), label = "title_glow"
                                    )
                                    
                                    Text(
                                        text = "Security Analysis",
                                        style = MaterialTheme.typography.titleMedium.copy(
                                            fontWeight = FontWeight.SemiBold
                                        ),
                                        color = NeonCyan.copy(alpha = titleAlpha),
                                        textAlign = TextAlign.Center
                                    )
                                    
                                    Spacer(modifier = Modifier.height(8.dp))
                                    
                                    Text(
                                        text = "Advanced AI will analyze all installed applications for potential security threats",
                                        style = MaterialTheme.typography.bodyMedium,
                                        color = Color.White.copy(alpha = 0.8f),
                                        textAlign = TextAlign.Center,
                                        lineHeight = 18.sp
                                    )
                                }
                            }
                        }
                    }
                }
            } else {
                // Results interface - check if we have results to show
                if (scanResults.isNotEmpty()) {
                    ScanResultsList(
                        results = filteredResults,
                        userAppsCount = userAppsCount,
                        systemAppsCount = systemAppsCount,
                        showSystemApps = showSystemApps,
                        onToggleView = { showSystemApps = it },
                        navController = navController
                    )
                } else {
                    // If no results but showResults is true, show a message with option to rescan
                    Column(
                        modifier = Modifier.fillMaxSize(),
                        horizontalAlignment = Alignment.CenterHorizontally,
                        verticalArrangement = Arrangement.Center
                    ) {
                        Card(
                            modifier = Modifier
                                .fillMaxWidth()
                                .padding(horizontal = 32.dp),
                            colors = CardDefaults.cardColors(
                                containerColor = Color(0xFF1A1A2E).copy(alpha = 0.8f)
                            ),
                            shape = RoundedCornerShape(12.dp),
                            border = BorderStroke(1.dp, NeonCyan.copy(alpha = 0.3f))
                        ) {
                            Column(
                                modifier = Modifier.padding(24.dp),
                                horizontalAlignment = Alignment.CenterHorizontally
                            ) {
                                Text(
                                    text = "No scan results available",
                                    style = MaterialTheme.typography.titleMedium.copy(
                                        fontWeight = FontWeight.Bold
                                    ),
                                    color = Color.White
                                )
                                
                                Spacer(modifier = Modifier.height(8.dp))
                                
                                Text(
                                    text = "Please start a new scan to view results",
                                    style = MaterialTheme.typography.bodyMedium,
                                    color = Color.White.copy(alpha = 0.7f),
                                    textAlign = TextAlign.Center
                                )
                                
                                Spacer(modifier = Modifier.height(16.dp))
                                
                                Button(
                                    onClick = { showResults = false },
                                    colors = ButtonDefaults.buttonColors(
                                        containerColor = NeonCyan
                                    ),
                                    shape = RoundedCornerShape(8.dp)
                                ) {
                                    Text(
                                        text = "Start New Scan",
                                        color = Color.Black,
                                        fontWeight = FontWeight.SemiBold
                                    )
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

@Composable
fun ScanningProgress(progress: Float, currentApp: String) {
    Column(
        horizontalAlignment = Alignment.CenterHorizontally,
        modifier = Modifier.fillMaxWidth()
    ) {
        Text(
            text = "SCANNING APPLICATIONS...",
            style = MaterialTheme.typography.titleMedium.copy(
                fontWeight = FontWeight.Bold,
                letterSpacing = 1.sp
            ),
            color = NeonCyan
        )
        
        Spacer(modifier = Modifier.height(16.dp))
        
        LinearProgressIndicator(
            progress = progress,
            modifier = Modifier
                .fillMaxWidth(0.8f)
                .height(8.dp),
            color = NeonCyan,
            trackColor = DarkGray
        )
        
        Spacer(modifier = Modifier.height(8.dp))
        
        Text(
            text = "${(progress * 100).toInt()}%",
            style = MaterialTheme.typography.bodyLarge.copy(
                fontWeight = FontWeight.Bold
            ),
            color = Color.White
        )
        
        if (currentApp.isNotEmpty()) {
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                text = "Analyzing: $currentApp",
                style = MaterialTheme.typography.bodySmall,
                color = Color.White.copy(alpha = 0.7f),
                maxLines = 1
            )
        }
    }
}

@Composable
fun ScanResultsList(
    results: List<ScanResult.Success>,
    userAppsCount: Int,
    systemAppsCount: Int,
    showSystemApps: Boolean,
    onToggleView: (Boolean) -> Unit,
    navController: NavController
) {
    Column(
        modifier = Modifier.fillMaxSize()
    ) {
        // Add spacing to push toggle buttons down
        Spacer(modifier = Modifier.height(24.dp))
        
        // Toggle buttons for User Apps / System Apps (Enterprise style)
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalArrangement = Arrangement.SpaceEvenly
        ) {
            CyberToggleButton(
                text = "USER APPS",
                isSelected = !showSystemApps,
                onClick = { onToggleView(false) }
            )
            CyberToggleButton(
                text = "SYSTEM APPS", 
                isSelected = showSystemApps,
                onClick = { onToggleView(true) }
            )
        }

        // Professional Summary header
        val threatCount = results.count { it.prediction == ThreatLevel.MALWARE }
        val suspiciousCount = results.count { it.prediction == ThreatLevel.SUSPICIOUS }
        
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp),
            colors = CardDefaults.cardColors(
                containerColor = Color(0xFF1A1A2E).copy(alpha = 0.8f)
            ),
            shape = RoundedCornerShape(12.dp), // Reduced from 16.dp to make smaller
            border = BorderStroke(1.dp, NeonCyan.copy(alpha = 0.3f))
        ) {
            Column(
                modifier = Modifier.padding(16.dp), // Reduced from 24.dp to make smaller
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Text(
                    text = "SCAN RESULTS", // Changed from "SCAN COMPLETE"
                    style = MaterialTheme.typography.titleMedium.copy( // Reduced from titleLarge
                        fontWeight = FontWeight.ExtraBold,
                        letterSpacing = 1.5.sp // Reduced letter spacing
                    ),
                    color = NeonCyan
                )
                
                Spacer(modifier = Modifier.height(12.dp)) // Reduced from 16.dp
                
                Row(
                    horizontalArrangement = Arrangement.SpaceEvenly,
                    modifier = Modifier.fillMaxWidth()
                ) {
                    // Threats
                    Column(
                        horizontalAlignment = Alignment.CenterHorizontally
                    ) {
                        Box(
                            modifier = Modifier
                                .size(60.dp)
                                .background(
                                    Color.Red.copy(alpha = 0.2f),
                                    shape = androidx.compose.foundation.shape.CircleShape
                                ),
                            contentAlignment = Alignment.Center
                        ) {
                            Text(
                                text = "$threatCount",
                                style = MaterialTheme.typography.headlineMedium.copy(
                                    fontWeight = FontWeight.ExtraBold
                                ),
                                color = Color.Red
                            )
                        }
                        Spacer(modifier = Modifier.height(8.dp))
                        Text(
                            text = "THREATS",
                            style = MaterialTheme.typography.labelMedium.copy(
                                fontWeight = FontWeight.Bold,
                                letterSpacing = 1.sp
                            ),
                            color = Color.White.copy(alpha = 0.8f)
                        )
                    }
                    
                    // Suspicious
                    Column(
                        horizontalAlignment = Alignment.CenterHorizontally
                    ) {
                        Box(
                            modifier = Modifier
                                .size(60.dp)
                                .background(
                                    Color.Yellow.copy(alpha = 0.2f),
                                    shape = androidx.compose.foundation.shape.CircleShape
                                ),
                            contentAlignment = Alignment.Center
                        ) {
                            Text(
                                text = "$suspiciousCount",
                                style = MaterialTheme.typography.headlineMedium.copy(
                                    fontWeight = FontWeight.ExtraBold
                                ),
                                color = Color.Yellow
                            )
                        }
                        Spacer(modifier = Modifier.height(8.dp))
                        Text(
                            text = "SUSPICIOUS",
                            style = MaterialTheme.typography.labelMedium.copy(
                                fontWeight = FontWeight.Bold,
                                letterSpacing = 1.sp
                            ),
                            color = Color.White.copy(alpha = 0.8f)
                        )
                    }
                    
                    // Total
                    Column(
                        horizontalAlignment = Alignment.CenterHorizontally
                    ) {
                        Box(
                            modifier = Modifier
                                .size(60.dp)
                                .background(
                                    NeonCyan.copy(alpha = 0.2f),
                                    shape = androidx.compose.foundation.shape.CircleShape
                                ),
                            contentAlignment = Alignment.Center
                        ) {
                            Text(
                                text = "${results.size}",
                                style = MaterialTheme.typography.headlineMedium.copy(
                                    fontWeight = FontWeight.ExtraBold
                                ),
                                color = NeonCyan
                            )
                        }
                        Spacer(modifier = Modifier.height(8.dp))
                        Text(
                            text = "TOTAL",
                            style = MaterialTheme.typography.labelMedium.copy(
                                fontWeight = FontWeight.Bold,
                                letterSpacing = 1.sp
                            ),
                            color = Color.White.copy(alpha = 0.8f)
                        )
                    }
                }
            }
        }
        
        Spacer(modifier = Modifier.height(16.dp))
        
        // Results list
        LazyColumn(
            modifier = Modifier.fillMaxSize(),
            contentPadding = PaddingValues(horizontal = 16.dp, vertical = 8.dp),
            verticalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            items(results) { result ->
                ScanResultCard(
                    result = result,
                    onClick = {
                        navController.navigate("app_report/${result.packageName}/${result.appName}") {
                            // Ensure we can navigate back to results
                        }
                    }
                )
            }
        }
    }
}

@Composable
fun ScanResultCard(
    result: ScanResult.Success,
    onClick: () -> Unit = {}
) {
    val context = LocalContext.current
    val pm = context.packageManager
    
    // Get app icon
    val appIcon = remember(result.packageName) {
        try {
            pm.getApplicationIcon(result.packageName)
        } catch (e: Exception) {
            null
        }
    }
    
    // Calculate app size
    val appSizeMB = remember(result.packageName) {
        try {
            val appInfo = pm.getApplicationInfo(result.packageName, 0)
            val apkFile = java.io.File(appInfo.sourceDir)
            apkFile.length().toDouble() / (1024 * 1024)
        } catch (e: Exception) {
            0.0
        }
    }
    
    Card(
        modifier = Modifier
            .padding(horizontal = 12.dp, vertical = 6.dp)
            .fillMaxWidth()
            .clickable { onClick() },
        shape = RoundedCornerShape(12.dp),
        elevation = CardDefaults.cardElevation(4.dp),
        colors = CardDefaults.cardColors(
            containerColor = DarkGray.copy(alpha = 0.3f)
        )
    ) {
        Row(
            modifier = Modifier
                .padding(12.dp)
                .fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween
        ) {
            // App Icon
            appIcon?.let {
                androidx.compose.foundation.Image(
                    bitmap = it.toBitmap().asImageBitmap(),
                    contentDescription = null,
                    modifier = Modifier.size(50.dp)
                )
            } ?: run {
                Box(
                    modifier = Modifier
                        .size(50.dp)
                        .background(
                            DarkGray.copy(alpha = 0.5f),
                            shape = RoundedCornerShape(8.dp)
                        ),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(
                        Icons.Default.Star,
                        contentDescription = null,
                        tint = Color.White.copy(alpha = 0.5f),
                        modifier = Modifier.size(24.dp)
                    )
                }
            }

            Spacer(modifier = Modifier.width(12.dp))

            Column(modifier = Modifier.weight(1f)) {
                Text(
                    text = result.appName,
                    style = MaterialTheme.typography.titleSmall.copy(
                        color = Color.White,
                        fontWeight = FontWeight.Medium
                    )
                )
                Text(
                    text = result.packageName,
                    style = MaterialTheme.typography.bodySmall.copy(
                        color = Color.White.copy(alpha = 0.7f)
                    )
                )
                Text(
                    text = "Size: %.1f MB".format(appSizeMB),
                    style = MaterialTheme.typography.bodySmall.copy(
                        color = NeonCyan.copy(alpha = 0.8f)
                    )
                )
            }

            StatusBadge(result.prediction.displayName)
        }
    }
}

@Composable
fun EnhancedScanButton(
    text: String,
    onClick: () -> Unit,
    glowIntensity: Float
) {
    Box(
        modifier = Modifier
            .fillMaxWidth(0.8f)
            .height(56.dp)
    ) {
        // Glow effect
        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(
                    NeonCyan.copy(alpha = 0.3f * glowIntensity),
                    shape = RoundedCornerShape(28.dp)
                )
                .blur(12.dp)
        )

        // Main button
        Box(
            contentAlignment = Alignment.Center,
            modifier = Modifier
                .fillMaxSize()
                .background(
                    Brush.horizontalGradient(
                        colors = listOf(
                            NeonCyan.copy(alpha = 0.9f),
                            NeonCyan,
                            NeonCyan.copy(alpha = 0.9f)
                        )
                    ),
                    shape = RoundedCornerShape(28.dp)
                )
                .border(
                    2.dp,
                    Color.White.copy(alpha = 0.3f),
                    RoundedCornerShape(28.dp)
                )
                .clickable { onClick() }
        ) {
            Text(
                text = text,
                style = MaterialTheme.typography.labelLarge.copy(
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold,
                    letterSpacing = 2.sp
                ),
                color = DarkNavy
            )
        }
    }
}

@Composable
fun CyberToggleButton(
    text: String,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    Box(
        modifier = Modifier
            .background(
                if (isSelected) NeonCyan.copy(alpha = 0.3f) else Color.Transparent,
                shape = RoundedCornerShape(20.dp)
            )
            .border(
                1.dp,
                if (isSelected) NeonCyan else Color.White.copy(alpha = 0.3f),
                RoundedCornerShape(20.dp)
            )
            .clickable { onClick() }
            .padding(horizontal = 24.dp, vertical = 12.dp)
    ) {
        Text(
            text = text,
            style = MaterialTheme.typography.labelMedium.copy(
                fontWeight = FontWeight.Bold
            ),
            color = if (isSelected) NeonCyan else Color.White.copy(alpha = 0.7f)
        )
    }
}