package com.example.androidmalwaredetector.ui.screens

import androidx.compose.animation.core.*
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Star
import androidx.compose.material.icons.filled.Warning
import androidx.compose.material.icons.filled.CheckCircle
import androidx.compose.material.icons.filled.Close
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.blur
import androidx.compose.ui.draw.scale
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.asImageBitmap
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.unit.sp
import androidx.navigation.NavController
import androidx.core.graphics.drawable.toBitmap
import com.example.androidmalwaredetector.scanner.DroidGuardScanner
import com.example.androidmalwaredetector.scanner.ScanConfig
import com.example.androidmalwaredetector.scanner.ScanResult
import com.example.androidmalwaredetector.scanner.ThreatLevel
import com.example.androidmalwaredetector.ui.components.StatusBadge
import com.example.androidmalwaredetector.ui.theme.DarkNavy
import com.example.androidmalwaredetector.ui.theme.NeonCyan
import com.example.androidmalwaredetector.ui.theme.DarkGray
import com.example.androidmalwaredetector.util.uploadMLAnalysisResults
import kotlinx.coroutines.launch
import com.example.androidmalwaredetector.ui.components.RevealScanPanel

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun UserScanScreen(navController: NavController) {
    val context = LocalContext.current
    val scope = rememberCoroutineScope()
    
    var isScanning by remember { mutableStateOf(false) }
    var scanResults by remember { mutableStateOf<List<ScanResult>>(emptyList()) }
    var scanProgress by remember { mutableStateOf(0f) }
    var currentScanning by remember { mutableStateOf("") }
    var showResults by remember { mutableStateOf(false) }
    var showSystemApps by remember { mutableStateOf(false) } // Toggle between user and system apps
    
    val scanner = remember { DroidGuardScanner(context) }
    
    // Filter results based on current view
    val filteredResults = remember(scanResults, showSystemApps) {
        scanResults.filterIsInstance<ScanResult.Success>().filter { result ->
            val isSystemApp = result.isSystemApp ?: false
            if (showSystemApps) isSystemApp else !isSystemApp
        }
    }
    
    // Count user and system apps
    val userAppsCount = remember(scanResults) {
        scanResults.filterIsInstance<ScanResult.Success>().count { !(it.isSystemApp ?: false) }
    }
    val systemAppsCount = remember(scanResults) {
        scanResults.filterIsInstance<ScanResult.Success>().count { it.isSystemApp ?: false }
    }
    
    // Animation for scan button
    val infiniteTransition = rememberInfiniteTransition(label = "scan_glow")
    val glowAnimation by infiniteTransition.animateFloat(
        initialValue = 0.6f,
        targetValue = 1f,
        animationSpec = infiniteRepeatable(
            animation = tween(2000),
            repeatMode = RepeatMode.Reverse
        ),
        label = "scan_glow"
    )

    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(
                Brush.verticalGradient(
                    colors = listOf(
                        DarkNavy,
                        Color(0xFF0D1421),
                        DarkNavy
                    )
                )
            )
    ) {
        Column(
            modifier = Modifier.fillMaxSize(),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            // Top App Bar - keep only back arrow, remove title
            TopAppBar(
                title = { },
                navigationIcon = {
                    IconButton(onClick = { navController.popBackStack() }) {
                        Icon(
                            Icons.Default.ArrowBack,
                            contentDescription = "Back",
                            tint = Color.White
                        )
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = Color.Transparent
                )
            )

            if (!showResults) {
                // Scan interface - fully centered
                Box(
                    modifier = Modifier.fillMaxSize(),
                    contentAlignment = Alignment.Center
                ) {
                    if (isScanning) {
                        // Enhanced scanning progress UI
                        Column(
                            horizontalAlignment = Alignment.CenterHorizontally,
                            verticalArrangement = Arrangement.Center
                        ) {
                            // Large circular progress with app icon
                            Box(
                                contentAlignment = Alignment.Center,
                                modifier = Modifier.size(200.dp)
                            ) {
                                // Outer glow effect
                                Box(
                                    modifier = Modifier
                                        .size(220.dp)
                                        .background(
                                            NeonCyan.copy(alpha = 0.1f),
                                            shape = androidx.compose.foundation.shape.CircleShape
                                        )
                                        .blur(20.dp)
                                )
                                
                                // Main circular progress
                                CircularProgressIndicator(
                                    progress = scanProgress,
                                    modifier = Modifier.size(180.dp),
                                    color = NeonCyan,
                                    strokeWidth = 6.dp,
                                    trackColor = Color.White.copy(alpha = 0.1f)
                                )
                                
                                // App icon container with better styling
                                Box(
                                    contentAlignment = Alignment.Center,
                                    modifier = Modifier
                                        .size(120.dp)
                                        .background(
                                            Color.White.copy(alpha = 0.15f),
                                            shape = androidx.compose.foundation.shape.CircleShape
                                        )
                                        .border(
                                            2.dp,
                                            NeonCyan.copy(alpha = 0.3f),
                                            androidx.compose.foundation.shape.CircleShape
                                        )
                                ) {
                                    // Show actual app icon with better quality
                                    if (currentScanning.isNotEmpty()) {
                                        val packageManager = context.packageManager
                                        val appIconDrawable = remember(currentScanning) {
                                            try {
                                                val appInfo = packageManager.getApplicationInfo(currentScanning, 0)
                                                packageManager.getApplicationIcon(appInfo)
                                            } catch (e: Exception) {
                                                null
                                            }
                                        }
                                        
                                        if (appIconDrawable != null) {
                                            val bitmap = remember(appIconDrawable) {
                                                appIconDrawable.toBitmap(80, 80) // Higher resolution
                                            }
                                            val imageBitmap = remember(bitmap) {
                                                bitmap.asImageBitmap()
                                            }
                                            
                                            Image(
                                                bitmap = imageBitmap,
                                                contentDescription = "Current App Icon",
                                                modifier = Modifier
                                                    .size(80.dp)
                                                    .background(
                                                        Color.White,
                                                        shape = RoundedCornerShape(16.dp)
                                                    )
                                                    .padding(8.dp)
                                            )
                                        } else {
                                            // Enhanced fallback icon
                                            Icon(
                                                Icons.Default.Star,
                                                contentDescription = "Current App",
                                                modifier = Modifier.size(50.dp),
                                                tint = NeonCyan
                                            )
                                        }
                                    } else {
                                        // Default scanner icon
                                        Icon(
                                            Icons.Default.Star,
                                            contentDescription = "Scanner",
                                            modifier = Modifier.size(50.dp),
                                            tint = NeonCyan
                                        )
                                    }
                                }
                            }
                            
                            Spacer(modifier = Modifier.height(32.dp))
                            
                            // Scanning status text
                            Text(
                                text = "SCANNING APPLICATIONS",
                                style = MaterialTheme.typography.titleMedium.copy(
                                    fontWeight = FontWeight.Bold,
                                    letterSpacing = 2.sp
                                ),
                                color = NeonCyan
                            )
                            
                            Spacer(modifier = Modifier.height(12.dp))
                            
                            // App name being analyzed with better styling
                            if (currentScanning.isNotEmpty()) {
                                Card(
                                    modifier = Modifier.padding(horizontal = 24.dp),
                                    colors = CardDefaults.cardColors(
                                        containerColor = Color.White.copy(alpha = 0.1f)
                                    ),
                                    shape = RoundedCornerShape(12.dp)
                                ) {
                                    Text(
                                        text = currentScanning,
                                        style = MaterialTheme.typography.bodyMedium,
                                        color = Color.White.copy(alpha = 0.9f),
                                        textAlign = TextAlign.Center,
                                        modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)
                                    )
                                }
                                
                                Spacer(modifier = Modifier.height(16.dp))
                            }
                            
                            // Large percentage display
                            Text(
                                text = "${(scanProgress * 100).toInt()}%",
                                style = MaterialTheme.typography.displayMedium.copy(
                                    fontWeight = FontWeight.ExtraBold
                                ),
                                color = Color.White
                            )
                            
                            Spacer(modifier = Modifier.height(48.dp))
                            
                            // Enhanced stop scanning button
                            Button(
                                onClick = { 
                                    isScanning = false
                                    showResults = false
                                },
                                colors = ButtonDefaults.buttonColors(
                                    containerColor = Color(0xFFFF6B6B) // Modern red color
                                ),
                                modifier = Modifier
                                    .width(200.dp)
                                    .height(50.dp),
                                shape = RoundedCornerShape(25.dp),
                                elevation = ButtonDefaults.buttonElevation(
                                    defaultElevation = 8.dp,
                                    pressedElevation = 4.dp
                                )
                            ) {
                                Text(
                                    text = "Stop Scanning",
                                    color = Color.White,
                                    style = MaterialTheme.typography.bodyLarge.copy(
                                        fontWeight = FontWeight.SemiBold
                                    )
                                )
                            }
                        }
                    } else {
                        // Extracted start scan lambda so RevealScanPanel can call same flow
                        val startScan: () -> Unit = {
                            scope.launch {
                                isScanning = true
                                scanProgress = 0f
                                scanResults = emptyList()

                                val results = scanner.scanAllInstalledApps(
                                    config = ScanConfig(includeSystemApps = true) // Include both user and system apps
                                ) { completed, total, packageName ->
                                    scanProgress = completed.toFloat() / total.toFloat()
                                    currentScanning = packageName
                                }

                                scanResults = results

                                // Upload ML analysis results to backend for user apps only
                                try {
                                    val successResults = results.filterIsInstance<ScanResult.Success>()
                                    uploadMLAnalysisResults(context, successResults)
                                } catch (e: Exception) {
                                    // Log error but don't interrupt UI flow
                                    e.printStackTrace()
                                }

                                isScanning = false
                                showResults = true
                            }
                        }

                        // Professional interactive scan button
                        Column(
                            horizontalAlignment = Alignment.CenterHorizontally,
                            verticalArrangement = Arrangement.Center
                        ) {
                            // Professional button with subtle interactive effects
                            var isPressed by remember { mutableStateOf(false) }
                            var isHovered by remember { mutableStateOf(false) }
                            
                            // Subtle glow animation for professional appeal
                            val infiniteTransition = rememberInfiniteTransition(label = "professional_glow")
                            val glowIntensity by infiniteTransition.animateFloat(
                                initialValue = 0.6f,
                                targetValue = 1f,
                                animationSpec = infiniteRepeatable(
                                    animation = tween(2500, easing = FastOutSlowInEasing),
                                    repeatMode = RepeatMode.Reverse
                                ), label = "glow"
                            )
                            
                            // Professional scale animation
                            val buttonScale by animateFloatAsState(
                                targetValue = when {
                                    isPressed -> 0.95f
                                    isHovered -> 1.02f
                                    else -> 1f
                                },
                                animationSpec = spring(
                                    dampingRatio = Spring.DampingRatioMediumBouncy,
                                    stiffness = Spring.StiffnessMedium
                                ),
                                label = "button_scale"
                            )
                            
                            // Subtle elevation change
                            val buttonElevation by animateFloatAsState(
                                targetValue = if (isPressed) 6.dp.value else 12.dp.value,
                                animationSpec = tween(150),
                                label = "elevation"
                            )
                            
                            Box(
                                contentAlignment = Alignment.Center,
                                modifier = Modifier.size(220.dp)
                            ) {
                                // Subtle professional glow effect
                                Box(
                                    modifier = Modifier
                                        .size(240.dp)
                                        .scale(buttonScale)
                                        .background(
                                            brush = Brush.radialGradient(
                                                colors = listOf(
                                                    NeonCyan.copy(alpha = 0.2f * glowIntensity),
                                                    NeonCyan.copy(alpha = 0.1f * glowIntensity),
                                                    Color.Transparent
                                                ),
                                                radius = 300f
                                            ),
                                            shape = androidx.compose.foundation.shape.CircleShape
                                        )
                                        .blur(8.dp)
                                )
                                
                                // Professional scan button
                                Button(
                                    onClick = { startScan() },
                                    modifier = Modifier
                                        .size(200.dp)
                                        .scale(buttonScale)
                                        .pointerInput(Unit) {
                                            detectTapGestures(
                                                onPress = {
                                                    isPressed = true
                                                    isHovered = true
                                                    tryAwaitRelease()
                                                    isPressed = false
                                                    kotlinx.coroutines.delay(100)
                                                    isHovered = false
                                                }
                                            )
                                        },
                                    colors = ButtonDefaults.buttonColors(
                                        containerColor = NeonCyan.copy(alpha = 0.9f)
                                    ),
                                    shape = androidx.compose.foundation.shape.CircleShape,
                                    elevation = ButtonDefaults.buttonElevation(
                                        defaultElevation = buttonElevation.dp,
                                        pressedElevation = 6.dp
                                    ),
                                    border = BorderStroke(
                                        width = if (isHovered) 3.dp else 2.dp,
                                        brush = Brush.radialGradient(
                                            colors = listOf(
                                                Color.White.copy(alpha = if (isHovered) 0.6f else 0.3f),
                                                Color.White.copy(alpha = if (isHovered) 0.4f else 0.2f)
                                            )
                                        )
                                    )
                                ) {
                                    Column(
                                        horizontalAlignment = Alignment.CenterHorizontally,
                                        verticalArrangement = Arrangement.Center
                                    ) {
                                        // Subtle text animation
                                        val textAlpha by animateFloatAsState(
                                            targetValue = if (isPressed) 0.8f else 1f,
                                            animationSpec = tween(150),
                                            label = "text_alpha"
                                        )
                                        
                                        Text(
                                            text = "SCAN NOW",
                                            style = MaterialTheme.typography.titleMedium.copy(
                                                fontWeight = FontWeight.Bold,
                                                letterSpacing = 2.sp
                                            ),
                                            color = Color.White.copy(alpha = textAlpha),
                                            textAlign = TextAlign.Center
                                        )
                                        
                                        Spacer(modifier = Modifier.height(6.dp))
                                        
                                        Text(
                                            text = "AI Analysis",
                                            style = MaterialTheme.typography.bodySmall.copy(
                                                fontWeight = FontWeight.Medium,
                                                letterSpacing = 1.sp
                                            ),
                                            color = Color.White.copy(alpha = 0.85f * textAlpha),
                                            textAlign = TextAlign.Center
                                        )
                                        
                                        Spacer(modifier = Modifier.height(8.dp))
                                        
                                        // Professional indicator dots
                                        Row(
                                            horizontalArrangement = Arrangement.spacedBy(4.dp)
                                        ) {
                                            repeat(3) { index ->
                                                val dotAlpha by infiniteTransition.animateFloat(
                                                    initialValue = 0.3f,
                                                    targetValue = 0.8f,
                                                    animationSpec = infiniteRepeatable(
                                                        animation = tween(
                                                            durationMillis = 1500,
                                                            delayMillis = index * 200,
                                                            easing = FastOutSlowInEasing
                                                        ),
                                                        repeatMode = RepeatMode.Reverse
                                                    ), label = "dot_$index"
                                                )
                                                
                                                Box(
                                                    modifier = Modifier
                                                        .size(4.dp)
                                                        .background(
                                                            Color.White.copy(alpha = dotAlpha),
                                                            shape = androidx.compose.foundation.shape.CircleShape
                                                        )
                                                )
                                            }
                                        }
                                    }
                                }
                            }
                            
                            Spacer(modifier = Modifier.height(24.dp))
                            
                            // Professional instructional card with subtle effects
                            val cardScale by animateFloatAsState(
                                targetValue = if (isPressed) 1.02f else 1f,
                                animationSpec = spring(
                                    dampingRatio = Spring.DampingRatioMediumBouncy,
                                    stiffness = Spring.StiffnessLow
                                ),
                                label = "card_scale"
                            )
                            
                            val cardElevation by animateFloatAsState(
                                targetValue = if (isHovered) 6f else 4f,
                                animationSpec = tween(200),
                                label = "card_elevation"
                            )
                            
                            Card(
                                colors = CardDefaults.cardColors(
                                    containerColor = Color.White.copy(alpha = if (isHovered) 0.1f else 0.08f)
                                ),
                                shape = RoundedCornerShape(16.dp),
                                modifier = Modifier
                                    .padding(horizontal = 32.dp)
                                    .fillMaxWidth()
                                    .scale(cardScale),
                                elevation = CardDefaults.cardElevation(
                                    defaultElevation = cardElevation.dp
                                ),
                                border = BorderStroke(
                                    1.dp,
                                    NeonCyan.copy(alpha = if (isHovered) 0.3f else 0.2f)
                                )
                            ) {
                                Column(
                                    modifier = Modifier.padding(16.dp),
                                    horizontalAlignment = Alignment.CenterHorizontally
                                ) {
                                    // Subtle text animation for title
                                    val titleAlpha by infiniteTransition.animateFloat(
                                        initialValue = 0.8f,
                                        targetValue = 1f,
                                        animationSpec = infiniteRepeatable(
                                            animation = tween(3000, easing = FastOutSlowInEasing),
                                            repeatMode = RepeatMode.Reverse
                                        ), label = "title_glow"
                                    )
                                    
                                    Text(
                                        text = "Security Analysis",
                                        style = MaterialTheme.typography.titleMedium.copy(
                                            fontWeight = FontWeight.SemiBold
                                        ),
                                        color = NeonCyan.copy(alpha = titleAlpha),
                                        textAlign = TextAlign.Center
                                    )
                                    
                                    Spacer(modifier = Modifier.height(8.dp))
                                    
                                    Text(
                                        text = "Advanced AI will analyze all installed applications for potential security threats",
                                        style = MaterialTheme.typography.bodyMedium,
                                        color = Color.White.copy(alpha = 0.8f),
                                        textAlign = TextAlign.Center,
                                        lineHeight = 18.sp
                                    )
                                }
                            }
                        }
                    }
                }
            } else {
                // Auto-navigate to results - no button needed
                LaunchedEffect(Unit) {
                    kotlinx.coroutines.delay(500) // Small delay for smooth transition
                    showResults = true
                }
                
                // Results interface
                ScanResultsList(
                    results = filteredResults,
                    userAppsCount = userAppsCount,
                    systemAppsCount = systemAppsCount,
                    showSystemApps = showSystemApps,
                    onToggleView = { showSystemApps = it },
                    navController = navController
                )
            }
        }
    }
}

@Composable
fun ScanningProgress(progress: Float, currentApp: String) {
    Column(
        horizontalAlignment = Alignment.CenterHorizontally,
        modifier = Modifier.fillMaxWidth()
    ) {
        Text(
            text = "SCANNING APPLICATIONS...",
            style = MaterialTheme.typography.titleMedium.copy(
                fontWeight = FontWeight.Bold,
                letterSpacing = 1.sp
            ),
            color = NeonCyan
        )
        
        Spacer(modifier = Modifier.height(16.dp))
        
        LinearProgressIndicator(
            progress = progress,
            modifier = Modifier
                .fillMaxWidth(0.8f)
                .height(8.dp),
            color = NeonCyan,
            trackColor = DarkGray
        )
        
        Spacer(modifier = Modifier.height(8.dp))
        
        Text(
            text = "${(progress * 100).toInt()}%",
            style = MaterialTheme.typography.bodyLarge.copy(
                fontWeight = FontWeight.Bold
            ),
            color = Color.White
        )
        
        if (currentApp.isNotEmpty()) {
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                text = "Analyzing: $currentApp",
                style = MaterialTheme.typography.bodySmall,
                color = Color.White.copy(alpha = 0.7f),
                maxLines = 1
            )
        }
    }
}

@Composable
fun ScanResultsList(
    results: List<ScanResult.Success>,
    userAppsCount: Int,
    systemAppsCount: Int,
    showSystemApps: Boolean,
    onToggleView: (Boolean) -> Unit,
    navController: NavController
) {
    Column(
        modifier = Modifier.fillMaxSize()
    ) {
        // Toggle buttons for User Apps / System Apps
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            horizontalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            // User Apps Button
            Button(
                onClick = { onToggleView(false) },
                modifier = Modifier.weight(1f),
                colors = ButtonDefaults.buttonColors(
                    containerColor = if (!showSystemApps) NeonCyan else DarkGray.copy(alpha = 0.3f)
                ),
                shape = RoundedCornerShape(12.dp)
            ) {
                Text(
                    text = "User Apps ($userAppsCount)",
                    color = if (!showSystemApps) DarkNavy else Color.White,
                    fontWeight = FontWeight.Bold,
                    fontSize = 14.sp
                )
            }
            
            // System Apps Button
            Button(
                onClick = { onToggleView(true) },
                modifier = Modifier.weight(1f),
                colors = ButtonDefaults.buttonColors(
                    containerColor = if (showSystemApps) NeonCyan else DarkGray.copy(alpha = 0.3f)
                ),
                shape = RoundedCornerShape(12.dp)
            ) {
                Text(
                    text = "System Apps ($systemAppsCount)",
                    color = if (showSystemApps) DarkNavy else Color.White,
                    fontWeight = FontWeight.Bold,
                    fontSize = 14.sp
                )
            }
        }

        // Summary header
        val threatCount = results.count { it.prediction == ThreatLevel.MALWARE }
        val suspiciousCount = results.count { it.prediction == ThreatLevel.SUSPICIOUS }
        
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 16.dp),
            colors = CardDefaults.cardColors(
                containerColor = DarkGray.copy(alpha = 0.3f)
            ),
            shape = RoundedCornerShape(16.dp)
        ) {
            Column(
                modifier = Modifier.padding(16.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Text(
                    text = "SCAN COMPLETE",
                    style = MaterialTheme.typography.titleMedium.copy(
                        fontWeight = FontWeight.Bold,
                        letterSpacing = 1.sp
                    ),
                    color = Color.White
                )
                
                Spacer(modifier = Modifier.height(8.dp))
                
                Row(
                    horizontalArrangement = Arrangement.SpaceEvenly,
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        Text(
                            text = "$threatCount",
                            style = MaterialTheme.typography.headlineMedium.copy(
                                fontWeight = FontWeight.Bold
                            ),
                            color = Color.Red
                        )
                        Text(
                            text = "Threats",
                            style = MaterialTheme.typography.bodySmall,
                            color = Color.White.copy(alpha = 0.7f)
                        )
                    }
                    
                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        Text(
                            text = "$suspiciousCount",
                            style = MaterialTheme.typography.headlineMedium.copy(
                                fontWeight = FontWeight.Bold
                            ),
                            color = Color.Yellow
                        )
                        Text(
                            text = "Suspicious",
                            style = MaterialTheme.typography.bodySmall,
                            color = Color.White.copy(alpha = 0.7f)
                        )
                    }
                    
                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        Text(
                            text = "${results.size}",
                            style = MaterialTheme.typography.headlineMedium.copy(
                                fontWeight = FontWeight.Bold
                            ),
                            color = Color.White
                        )
                        Text(
                            text = "Total",
                            style = MaterialTheme.typography.bodySmall,
                            color = Color.White.copy(alpha = 0.7f)
                        )
                    }
                }
            }
        }
        
        Spacer(modifier = Modifier.height(16.dp))
        
        // Results list
        LazyColumn(
            modifier = Modifier.fillMaxSize(),
            contentPadding = PaddingValues(horizontal = 16.dp, vertical = 8.dp),
            verticalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            items(results) { result ->
                ScanResultCard(
                    result = result,
                    onClick = {
                        navController.navigate("app_report/${result.packageName}/${result.appName}")
                    }
                )
            }
        }
    }
}

@Composable
fun ScanResultCard(
    result: ScanResult.Success,
    onClick: () -> Unit = {}
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .clickable { onClick() },
        colors = CardDefaults.cardColors(
            containerColor = DarkGray.copy(alpha = 0.2f)
        ),
        shape = RoundedCornerShape(12.dp),
        border = BorderStroke(
            1.dp,
            when (result.prediction) {
                ThreatLevel.MALWARE -> Color.Red.copy(alpha = 0.5f)
                ThreatLevel.SUSPICIOUS -> Color.Yellow.copy(alpha = 0.5f)
                ThreatLevel.SAFE -> Color.Green.copy(alpha = 0.3f)
                ThreatLevel.UNKNOWN -> Color.Gray.copy(alpha = 0.3f)
            }
        )
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            Icon(
                imageVector = when (result.prediction) {
                    ThreatLevel.MALWARE -> Icons.Default.Close
                    ThreatLevel.SUSPICIOUS -> Icons.Default.Warning
                    ThreatLevel.SAFE -> Icons.Default.CheckCircle
                    ThreatLevel.UNKNOWN -> Icons.Default.Star
                },
                contentDescription = null,
                tint = when (result.prediction) {
                    ThreatLevel.MALWARE -> Color.Red
                    ThreatLevel.SUSPICIOUS -> Color.Yellow
                    ThreatLevel.SAFE -> Color.Green
                    ThreatLevel.UNKNOWN -> Color.Gray
                },
                modifier = Modifier.size(24.dp)
            )
            
            Spacer(modifier = Modifier.width(16.dp))
            
            Column(
                modifier = Modifier.weight(1f)
            ) {
                Text(
                    text = result.appName,
                    style = MaterialTheme.typography.bodyLarge.copy(
                        fontWeight = FontWeight.Medium
                    ),
                    color = Color.White,
                    maxLines = 1
                )
                
                Text(
                    text = result.packageName,
                    style = MaterialTheme.typography.bodySmall,
                    color = Color.White.copy(alpha = 0.6f),
                    maxLines = 1
                )
            }
            
            Column(
                horizontalAlignment = Alignment.End
            ) {
                StatusBadge(
                    status = result.prediction.displayName
                )
                
                Text(
                    text = "${(result.confidence * 100).toInt()}%",
                    style = MaterialTheme.typography.bodySmall.copy(
                        fontWeight = FontWeight.Bold
                    ),
                    color = Color.White.copy(alpha = 0.8f)
                )
            }
        }
    }
}

@Composable
fun EnhancedScanButton(
    text: String,
    onClick: () -> Unit,
    glowIntensity: Float
) {
    Box(
        modifier = Modifier
            .fillMaxWidth(0.8f)
            .height(56.dp)
    ) {
        // Glow effect
        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(
                    NeonCyan.copy(alpha = 0.3f * glowIntensity),
                    shape = RoundedCornerShape(28.dp)
                )
                .blur(12.dp)
        )

        // Main button
        Box(
            contentAlignment = Alignment.Center,
            modifier = Modifier
                .fillMaxSize()
                .background(
                    Brush.horizontalGradient(
                        colors = listOf(
                            NeonCyan.copy(alpha = 0.9f),
                            NeonCyan,
                            NeonCyan.copy(alpha = 0.9f)
                        )
                    ),
                    shape = RoundedCornerShape(28.dp)
                )
                .border(
                    2.dp,
                    Color.White.copy(alpha = 0.3f),
                    RoundedCornerShape(28.dp)
                )
                .clickable { onClick() }
        ) {
            Text(
                text = text,
                style = MaterialTheme.typography.labelLarge.copy(
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold,
                    letterSpacing = 2.sp
                ),
                color = DarkNavy
            )
        }
    }
}