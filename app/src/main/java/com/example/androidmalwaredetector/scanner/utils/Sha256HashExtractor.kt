package com.example.androidmalwaredetector.scanner.utils

import java.io.*
import java.security.MessageDigest
import java.security.NoSuchAlgorithmException

/**
 * Utility SHA256 Hash Extractor class for use in multiple locations
 * Converted to Kotlin with improved error handling and modern conventions
 */
object Sha256HashExtractor {

    /**
     * Calculates SHA256 hash of a file
     * @param filePath Path to the file
     * @return SHA256 hash as hex string, or null if error occurs
     */
    fun getSha256Hash(filePath: String): String? {
        return try {
            val bytes = convertFileToByteArray(filePath) ?: return null
            getDigestHash(bytes)
        } catch (e: Exception) {
            e.printStackTrace()
            null
        }
    }

    /**
     * Reads file content into byte array
     * @param filePath Path to the file
     * @return File content as byte array, or null if error occurs
     */
    private fun convertFileToByteArray(filePath: String): ByteArray? {
        val file = File(filePath)
        if (!file.exists() || !file.isFile) {
            return null
        }

        return try {
            file.readBytes()
        } catch (e: IOException) {
            e.printStackTrace()
            null
        } catch (e: SecurityException) {
            e.printStackTrace()
            null
        }
    }

    /**
     * Calculates SHA256 digest from byte array
     * @param bytes Input bytes
     * @return SHA256 hash as hex string, or null if error occurs
     */
    private fun getDigestHash(bytes: ByteArray): String? {
        return try {
            val md = MessageDigest.getInstance("SHA-256")
            val digest = md.digest(bytes)
            bytesToHexString(digest)
        } catch (e: NoSuchAlgorithmException) {
            e.printStackTrace()
            null
        }
    }

    /**
     * Converts byte array to hex string
     * @param bytes Input bytes
     * @return Hex string representation
     */
    private fun bytesToHexString(bytes: ByteArray): String {
        return bytes.joinToString("") { byte ->
            "%02x".format(byte)
        }
    }

    /**
     * Calculates SHA256 hash of a byte array directly
     * @param bytes Input bytes
     * @return SHA256 hash as hex string, or null if error occurs
     */
    fun getSha256Hash(bytes: ByteArray): String? {
        return getDigestHash(bytes)
    }

    /**
     * Calculates SHA256 hash from InputStream
     * @param inputStream Input stream to read from
     * @return SHA256 hash as hex string, or null if error occurs
     */
    fun getSha256Hash(inputStream: InputStream): String? {
        return try {
            val bytes = inputStream.readBytes()
            getDigestHash(bytes)
        } catch (e: IOException) {
            e.printStackTrace()
            null
        } finally {
            try {
                inputStream.close()
            } catch (e: IOException) {
                // Ignore close errors
            }
        }
    }
}