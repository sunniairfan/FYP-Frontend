package com.example.androidmalwaredetector.scanner.utils

import android.content.Context
import android.content.pm.PackageManager
import android.content.res.XmlResourceParser
import org.xmlpull.v1.XmlPullParser
import org.xmlpull.v1.XmlPullParserException
import java.io.IOException
import java.lang.reflect.Method

/**
 * Utility class for extracting intent filters from Android applications
 * Converted from Java to Kotlin with improved error handling
 */
object IntentExtractor {

    /**
     * Extracts list of intent action names from the given application context
     * @param context Application context to extract intents from
     * @return List of intent action names, empty list if extraction fails
     */
    fun extractIntents(context: Context): List<String> {
        val intentList = mutableListOf<String>()
        
        try {
            val packageManager = context.packageManager
            val applicationInfo = packageManager.getApplicationInfo(context.packageName, 0)
            
            // Create package context and get asset manager
            val packageContext = context.createPackageContext(context.packageName, 0)
            val assetManager = packageContext.assets
            
            // Use reflection to add asset path (required for accessing AndroidManifest.xml)
            val addAssetPathMethod: Method = assetManager.javaClass.getMethod("addAssetPath", String::class.java)
            val cookie = addAssetPathMethod.invoke(assetManager, applicationInfo.sourceDir) as Int
            
            // Parse AndroidManifest.xml
            val xmlParser: XmlResourceParser = assetManager.openXmlResourceParser(cookie, "AndroidManifest.xml")
            
            var eventType = xmlParser.next()
            while (eventType != XmlPullParser.END_DOCUMENT) {
                if (eventType == XmlPullParser.START_TAG && "action" == xmlParser.name) {
                    // Extract action name from attributes
                    for (i in 0 until xmlParser.attributeCount) {
                        if ("name" == xmlParser.getAttributeName(i)) {
                            val actionName = xmlParser.getAttributeValue(i)
                            if (actionName.isNotBlank()) {
                                intentList.add(actionName)
                            }
                        }
                    }
                }
                eventType = xmlParser.next()
            }
            xmlParser.close()
            
        } catch (e: XmlPullParserException) {
            e.printStackTrace()
        } catch (e: PackageManager.NameNotFoundException) {
            e.printStackTrace()
        } catch (e: IOException) {
            e.printStackTrace()
        } catch (e: NoSuchMethodException) {
            e.printStackTrace()
        } catch (e: Exception) {
            e.printStackTrace()
        }
        
        return intentList
    }

    /**
     * Extracts intent filters from a specific package
     * @param context Application context
     * @param packageName Package name to extract intents from
     * @return List of intent action names, empty list if extraction fails
     */
    fun extractIntentsFromPackage(context: Context, packageName: String): List<String> {
        val intentList = mutableListOf<String>()
        
        try {
            val packageManager = context.packageManager
            val applicationInfo = packageManager.getApplicationInfo(packageName, 0)
            
            // Create package context for the target package
            val packageContext = context.createPackageContext(packageName, Context.CONTEXT_IGNORE_SECURITY)
            val assetManager = packageContext.assets
            
            // Use reflection to add asset path
            val addAssetPathMethod: Method = assetManager.javaClass.getMethod("addAssetPath", String::class.java)
            val cookie = addAssetPathMethod.invoke(assetManager, applicationInfo.sourceDir) as Int
            
            // Parse AndroidManifest.xml
            val xmlParser: XmlResourceParser = assetManager.openXmlResourceParser(cookie, "AndroidManifest.xml")
            
            var eventType = xmlParser.next()
            while (eventType != XmlPullParser.END_DOCUMENT) {
                if (eventType == XmlPullParser.START_TAG && "action" == xmlParser.name) {
                    // Extract action name from attributes
                    for (i in 0 until xmlParser.attributeCount) {
                        if ("name" == xmlParser.getAttributeName(i)) {
                            val actionName = xmlParser.getAttributeValue(i)
                            if (actionName.isNotBlank()) {
                                intentList.add(actionName)
                            }
                        }
                    }
                }
                eventType = xmlParser.next()
            }
            xmlParser.close()
            
        } catch (e: XmlPullParserException) {
            e.printStackTrace()
        } catch (e: PackageManager.NameNotFoundException) {
            e.printStackTrace()
        } catch (e: IOException) {
            e.printStackTrace()
        } catch (e: NoSuchMethodException) {
            e.printStackTrace()
        } catch (e: SecurityException) {
            e.printStackTrace()
        } catch (e: Exception) {
            e.printStackTrace()
        }
        
        return intentList
    }

    /**
     * Get common Android intent actions for fallback
     * @return List of common intent actions
     */
    fun getCommonIntentActions(): List<String> {
        return listOf(
            "android.intent.action.MAIN",
            "android.intent.action.VIEW",
            "android.intent.action.SEND",
            "android.intent.action.SENDTO",
            "android.intent.action.DIAL",
            "android.intent.action.CALL",
            "android.intent.action.BOOT_COMPLETED",
            "android.intent.action.PACKAGE_ADDED",
            "android.intent.action.PACKAGE_REMOVED",
            "android.intent.action.SCREEN_ON",
            "android.intent.action.SCREEN_OFF",
            "android.intent.action.USER_PRESENT",
            "android.intent.action.CAMERA_BUTTON",
            "android.intent.action.BATTERY_CHANGED",
            "android.intent.action.TIME_SET",
            "android.intent.action.TIMEZONE_CHANGED"
        )
    }
}